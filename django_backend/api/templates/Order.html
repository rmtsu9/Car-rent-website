<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Tracking</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'Env/css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'Env/css/order.css' %}?v=20260220d">
</head>
<body>
    <div
        class="order-page"
        id="orderPage"
        data-notifications-url="{% url 'user_notifications_api' %}"
        data-mark-notifications-read-url="{% url 'user_notifications_mark_read_api' %}"
    >
        <div class="back-button">
            <a href="{% url 'booking' %}" class="back-booking-btn">
                <span class="back-icon" aria-hidden="true">←</span>
                <span>Back to Booking</span>
            </a>
        </div>

        <header class="order-header">
            <h1>Order Tracking</h1>
            <p>Track each order from callback, deposit, handover, to full payment.</p>
        </header>

        <section class="notification-card">
            <div class="notification-header">
                <h3>Notifications</h3>
                <span class="notification-badge" id="notificationUnreadBadge">0 unread</span>
            </div>
            <div class="notification-list" id="notificationList">
                <p class="notification-empty">No notifications yet.</p>
            </div>
        </section>

        {% if selected_booking %}
            <section class="focus-card">
                <div class="focus-header">
                    <div>
                        <h2>Order #{{ selected_booking.id }}</h2>
                        <p>{{ selected_booking.car.name }}</p>
                    </div>
                    <span class="stage-badge{% if selected_booking.status == 'rejected' %} cancelled{% endif %}">
                        {% if selected_booking.status == "rejected" %}
                            Cancelled
                        {% else %}
                            {{ selected_booking.get_order_stage_display }}
                        {% endif %}
                    </span>
                </div>

                <div class="details-grid">
                    <div class="detail-item">
                        <span class="label">Pickup Date</span>
                        <strong>{{ selected_booking.start_date|date:"Y-m-d" }}</strong>
                    </div>
                    <div class="detail-item">
                        <span class="label">Return Date</span>
                        <strong>{{ selected_booking.end_date|date:"Y-m-d" }}</strong>
                    </div>
                    <div class="detail-item">
                        <span class="label">Current Province</span>
                        <strong>{{ selected_booking.current_province }}</strong>
                    </div>
                    <div class="detail-item">
                        <span class="label">Destination Province</span>
                        <strong>{{ selected_booking.destination_province }}</strong>
                    </div>
                    <div class="detail-item">
                        <span class="label">Pickup Type</span>
                        <strong>
                            {% if selected_booking.pickup_type == "delivery" %}
                                Delivery
                            {% else %}
                                Self Pickup
                            {% endif %}
                        </strong>
                    </div>
                    <div class="detail-item">
                        <span class="label">Contact Number</span>
                        <strong>{{ selected_booking.contact_number }}</strong>
                    </div>
                </div>

                {% if selected_booking.pickup_type == "delivery" %}
                    <div class="delivery-map-box">
                        <button
                            type="button"
                            class="btn-secondary open-delivery-map-btn"
                            data-delivery-lat="{{ selected_booking.delivery_lat }}"
                            data-delivery-lng="{{ selected_booking.delivery_lng }}"
                        >
                            เปิดแผนที่จุดส่ง
                        </button>
                        {% if selected_booking.delivery_address %}
                            <p class="delivery-map-address">Pinned location: {{ selected_booking.delivery_address }}</p>
                        {% endif %}
                    </div>
                {% elif shop_lat is not None and shop_lng is not None %}
                    <div class="delivery-map-box">
                        <button
                            type="button"
                            class="btn-secondary open-delivery-map-btn"
                            data-delivery-lat="{{ shop_lat }}"
                            data-delivery-lng="{{ shop_lng }}"
                        >
                            เปิดแผนที่จุดส่ง
                        </button>
                        <p class="delivery-map-address">
                            Self pickup location: {{ shop_name }}{% if shop_address %} - {{ shop_address }}{% endif %}
                        </p>
                    </div>
                {% endif %}

                <div class="price-card">
                    <div class="price-row">
                        <span>Total Price</span>
                        <strong>{{ selected_booking.total_price }} THB</strong>
                    </div>
                    <div class="price-row">
                        <span>Deposit (30%)</span>
                        <strong>{{ selected_booking.deposit }} THB</strong>
                    </div>
                    <div class="price-row">
                        <span>Remaining (70%)</span>
                        <strong>{{ selected_booking.remaining_amount }} THB</strong>
                    </div>
                </div>

                <div class="timeline">
                    {% for step in selected_progress %}
                        <div class="timeline-step {{ step.status }}">
                            <div class="step-number">{{ step.index }}</div>
                            <div class="step-title">{{ step.title }}</div>
                        </div>
                    {% endfor %}
                </div>

                <div class="status-panel">
                    {% if selected_booking.status == "rejected" %}
                        <p class="status-message error">This order was cancelled/rejected. You cannot continue this flow.</p>
                    {% elif selected_booking.order_stage == "completed" %}
                        <p class="status-message success">Full payment completed. This order is now saved to your History.</p>
                    {% elif selected_booking.order_stage == "awaiting_contact" %}
                        <p class="status-message info">Waiting for admin approval after callback confirmation.</p>
                    {% elif selected_booking.order_stage == "awaiting_handover" %}
                        <p class="status-message info">Waiting for admin approval to confirm pickup/delivery before full payment.</p>
                    {% elif selected_stage_action %}
                        <div class="status-actions">
                            <form method="POST" action="{% url 'advance_order_stage' selected_booking.id %}" id="advanceStageForm" class="status-action-form">
                                {% csrf_token %}
                                <button
                                    type="submit"
                                    class="btn-primary advance-stage-btn"
                                    data-final-payment="{{ selected_stage_action.is_final_payment|yesno:'true,false' }}"
                                    data-action-label="{{ selected_stage_action.label }}"
                                >
                                    {{ selected_stage_action.label }}
                                </button>
                            </form>

                            {% if selected_booking.status != "rejected" and selected_booking.order_stage != "completed" %}
                                <form method="POST" action="{% url 'cancel_order' selected_booking.id %}" id="cancelOrderForm" class="cancel-order-form">
                                    {% csrf_token %}
                                    <button type="submit" class="btn-cancel-order cancel-order-btn">Cancel this order</button>
                                </form>
                            {% endif %}
                        </div>
                    {% endif %}

                    {% if selected_booking.status != "rejected" and selected_booking.order_stage != "completed" and not selected_stage_action %}
                        <div class="status-actions">
                            <form method="POST" action="{% url 'cancel_order' selected_booking.id %}" id="cancelOrderForm" class="cancel-order-form">
                                {% csrf_token %}
                                <button type="submit" class="btn-cancel-order cancel-order-btn">Cancel this order</button>
                            </form>
                        </div>
                    {% endif %}
                </div>
            </section>
        {% else %}
            <section class="empty-state">
                <h2>No Orders Yet</h2>
                <p>Create your first booking to start tracking order progress.</p>
                <a href="{% url 'booking' %}">Go to Booking</a>
            </section>
        {% endif %}

        <section class="order-list-card">
            <h3>Your Orders</h3>
            {% if bookings %}
                <div class="order-list">
                    {% for booking in bookings %}
                        <a
                            href="{% url 'order' %}?booking_id={{ booking.id }}"
                            class="order-item {% if selected_booking and selected_booking.id == booking.id %}active{% endif %}"
                        >
                            <div>
                                <strong>#{{ booking.id }} - {{ booking.car.name }}</strong>
                                <small>{{ booking.start_date|date:"Y-m-d" }} to {{ booking.end_date|date:"Y-m-d" }}</small>
                            </div>
                            <span>
                                {% if booking.status == "rejected" %}
                                    Cancelled
                                {% else %}
                                    {{ booking.get_order_stage_display }}
                                {% endif %}
                            </span>
                        </a>
                    {% endfor %}
                </div>
            {% else %}
                <p class="empty-list">No orders found.</p>
            {% endif %}
        </section>
    </div>

    <script src="{% static 'Env/js/order.js' %}?v=20260220c"></script>
</body>
</html>
